name: Node.js CI/CD

on:
    push:
        branches: [ main ]

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
        - name: Checkout code
          uses: actions/checkout@v2

        - name: Set up Node.js
          uses: actions/setup-node@v2
          with:
                node-version: '14'

        - name: Install server dependencies
          run: cd server && npm ci

        - name: Install client dependencies
          run: cd client && npm ci

        - name: Run server tests
          run: cd server && npm test

        - name: Run client tests
          run: cd client && npm test

        - name: Build client
          run: cd client && npm run build

        - name: Deploy to EC2
          uses: appleboy/ssh-action@master
          with:
            host: ${{ secrets.EC2_HOST }}
            username: ${{ secrets.EC2_USERNAME }}
            key: ${{ secrets.EC2_SSH_KEY }}
            script: |
              source ~/.nvm/nvm.sh
              cd ~/globaltechno_app/
              git pull
              cd server && /home/ubuntu/.nvm/versions/node/v21.7.3/bin/npm ci --production
              cd ../client && /home/ubuntu/.nvm/versions/node/v21.7.3/bin/npm ci --production
              /home/ubuntu/.nvm/versions/node/v21.7.3/bin/pm2 restart all

        - name: Debug information
          run: |
            echo "Node.js version:"
            node -v
            echo "npm version:"
            npm -v
            echo "Operating system:"
            uname -a
            echo "package.json:"
            cat server/package.json
            echo "package-lock.json:"
            cat server/package-lock.json
            echo "List of global npm packages:"
            npm list -g --depth=0
          